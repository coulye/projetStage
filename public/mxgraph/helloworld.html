<html>
<head>
    <title>Hello, World! example for mxGraph</title>

    <!-- Sets the basepath for the library if not in same directory -->
    <script type="text/javascript">
        mxBasePath = 'src';
        directory_schema = JSON.parse('{\n' +
            '    "Accounts": {\n' +
            '        "collection": "accounts",\n' +
            '        "schema": {\n' +
            '            "nom": "String",\n' +
            '            "prenom": "String",\n' +
            '            "titre": "String",\n' +
            '            "sexe": "String",\n' +
            '            "login": {"type": "String", "unique": "true"},\n' +
            '            "password": "String",\n' +
            '            "email": "String",\n' +
            '            "telephone": "String",\n' +
            '            "adresse1": "String",\n' +
            '            "adresse2": "String",\n' +
            '            "code_postal": "String",\n' +
            '            "ville": "String",\n' +
            '            "actif": "Boolean",\n' +
            '            "notes": "String",\n' +
            '            "role": {\n' +
            '              "type": "ObjectId",\n' +
            '              "ref": "Role"\n' +
            '            },\n' +
            '            "functionalities": [{\n' +
            '              "type": "ObjectId",\n' +
            '              "ref": "Functionalities"\n' +
            '            }],\n' +
            '            "entreprise_id": {\n' +
            '                "type": "ObjectId",\n' +
            '                "ref": "Entreprises"\n' +
            '            }\n' +
            '        }\n' +
            '    },\n' +
            '    "AccountId": {\n' +
            '        "collection": "accounts",\n' +
            '        "schema": {\n' +
            '            "_id": "ObjectId",\n' +
            '            "nom": "String",\n' +
            '            "prenom": "String",\n' +
            '            "titre": "String",\n' +
            '            "sexe": "String",\n' +
            '            "login": {"type": "String", "unique": "true"},\n' +
            '            "password": "String",\n' +
            '            "email": "String",\n' +
            '            "telephone": "String",\n' +
            '            "adresse1": "String",\n' +
            '            "adresse2": "String",\n' +
            '            "code_postal": "String",\n' +
            '            "ville": "String",\n' +
            '            "actif": "Boolean",\n' +
            '            "notes": "String",\n' +
            '            "role": {\n' +
            '              "type": "ObjectId",\n' +
            '              "ref": "Role"\n' +
            '            }\n' +
            '        }\n' +
            '    },\n' +
            '    "Role": {\n' +
            '      "collection": "role",\n' +
            '      "schema": {\n' +
            '        "_id": "ObjectId",\n' +
            '        "code": "String",\n' +
            '        "libelle": "String"\n' +
            '      }\n' +
            '    },\n' +
            '    "LogsAccounts": {\n' +
            '        "collection": "logs",\n' +
            '        "schema": {\n' +
            '            "date": "String",\n' +
            '            "event": "String",\n' +
            '            "message": "String",\n' +
            '            "ip": "String",\n' +
            '            "session": "String",\n' +
            '            "user_id": {\n' +
            '                "type": "ObjectId",\n' +
            '                "ref": "Accounts"\n' +
            '            }\n' +
            '\n' +
            '        }\n' +
            '    },\n' +
            '    "Logs": {\n' +
            '      "collection": "logs",\n' +
            '      "schema": {\n' +
            '        "date": "String",\n' +
            '        "event": "String",\n' +
            '        "message": "String",\n' +
            '        "ip": "String",\n' +
            '        "session": "String"\n' +
            '      }\n' +
            '    },\n' +
            '    "Countries": {\n' +
            '      "collection": "countries",\n' +
            '      "schema": {\n' +
            '        "_id": "ObjectId",\n' +
            '        "name": "String",\n' +
            '        "code": "String"\n' +
            '      }\n' +
            '    },\n' +
            '    "Functionalities": {\n' +
            '        "collection": "functionalities",\n' +
            '        "schema": {\n' +
            '            "_id": "ObjectId",\n' +
            '            "title": "String",\n' +
            '            "color": "String",\n' +
            '            "iconfs": "String",\n' +
            '            "action_name": "String"\n' +
            '        }\n' +
            '    },\n' +
            '    "Entreprises": {\n' +
            '        "collection": "entreprises",\n' +
            '        "schema": {\n' +
            '            "_id": "ObjectId",\n' +
            '            "raison_sociale": "String",\n' +
            '            "adresse1": "String",\n' +
            '            "adresse2": "String",\n' +
            '            "code_postal": "String",\n' +
            '            "ville": "String",\n' +
            '            "siret": "String",\n' +
            '            "codeNAF": "String"\n' +
            '        }\n' +
            '    },\n' +
            '    "RegistreUniqueDuPersonnel": {\n' +
            '        "collection": "registre_unique_personnel",\n' +
            '        "schema": {\n' +
            '            "_id": "ObjectId",\n' +
            '            "nom": "String",\n' +
            '            "prenom": "String",\n' +
            '            "adresse": "String",\n' +
            '            "Num_SS": "String",\n' +
            '            "nationalite": "String",\n' +
            '            "date_naissance": "String",\n' +
            '            "sexe": "String",\n' +
            '            "emploi_qualification": "String",\n' +
            '            "date_entree": "String",\n' +
            '            "date_sortie": "String",\n' +
            '            "trav_etranger_titre":"String",\n' +
            '            "trav_etranger_num_ordre": "String",\n' +
            '            "jeune_trav_apprentissage": "String",\n' +
            '            "jeune_trav_profess" : "String",\n' +
            '            "trav_contrat_specif_CDD": "String",\n' +
            '            "trav_contrat_specif_tps_partiel": "String",\n' +
            '            "trav_contrat_specif_autre":"String",\n' +
            '            "generer_fiche_form_habil_autor": "Boolean",\n' +
            '            "entreprise_id": {\n' +
            '                "type": "ObjectId",\n' +
            '                "ref": "Entreprises"\n' +
            '            }\n' +
            '        }\n' +
            '    },\n' +
            '    "TypeSuivi": {\n' +
            '        "collection": "type_suivi",\n' +
            '        "schema": {\n' +
            '            "_id": "ObjectId",\n' +
            '            "libelle": "String"\n' +
            '        }\n' +
            '    },\n' +
            '    "ListeFormations": {\n' +
            '        "collection": "liste_formations",\n' +
            '        "schema": {\n' +
            '            "_id": "ObjectId",\n' +
            '            "libelle": "String"\n' +
            '        }\n' +
            '    },\n' +
            '    "OrganismesFormations": {\n' +
            '        "collection": "organismes_formations",\n' +
            '        "schema": {\n' +
            '            "_id": "ObjectId",\n' +
            '            "raison_sociale" : "String",\n' +
            '            "adresse1": "String",\n' +
            '            "adresse2": "String",\n' +
            '            "code_postal": "String",\n' +
            '            "ville": "String",\n' +
            '            "email": "String",\n' +
            '            "liste_formations": [{\n' +
            '                "type": "ObjectId",\n' +
            '                "ref": "ListeFormations"\n' +
            '            }]\n' +
            '        }\n' +
            '    },\n' +
            '    "SuiviFormationHabilitationAutorisation": {\n' +
            '        "collection": "suivi_form_habil_autor",\n' +
            '        "schema": {\n' +
            '            "_id": "ObjectId",\n' +
            '            "personnel_id": {\n' +
            '                "type": "ObjectId",\n' +
            '                "ref": "RegistreUniqueDuPersonnel"\n' +
            '            },\n' +
            '            "type_suivi": {\n' +
            '                "type": "ObjectId",\n' +
            '                "ref": "TypeSuivi"\n' +
            '            },\n' +
            '            "type": "String",\n' +
            '            "date": "String",\n' +
            '            "validite": "String",\n' +
            '            "date_fin_validite": "String",\n' +
            '            "organisme_formation": {\n' +
            '                "type": "ObjectId",\n' +
            '                "ref" : "OrganismesFormations"\n' +
            '            }\n' +
            '        }\n' +
            '    },\n' +
            '    "RegistreSecuriteIncendie": {\n' +
            '        "collection": "registre_scurite_incendie",\n' +
            '        "schema": {\n' +
            '            "date_creation": "Date",\n' +
            '            "auteur_id": {\n' +
            '                "type": "ObjectId",\n' +
            '                "ref": "RegistreUniqueDuPersonnel"\n' +
            '            },\n' +
            '            "entreprise_id": {\n' +
            '                "type": "ObjectId",\n' +
            '                "ref": "Entreprises"\n' +
            '            },\n' +
            '            "maj_par": [\n' +
            '                {\n' +
            '                    "type": "ObjectId",\n' +
            '                    "ref": "RegistreUniqueDuPersonnel"\n' +
            '                }\n' +
            '            ],\n' +
            '            "maj_date": "Date",\n' +
            '            "maj_visa": "String",\n' +
            '            "num_tel_utiles": {\n' +
            '                "pompiers": "String",\n' +
            '                "police_gendarmerie": "String",\n' +
            '                "samu_smur": "String",\n' +
            '                "ambulance": "String",\n' +
            '                "medecin": "String",\n' +
            '                "hôpital": "String",\n' +
            '                "centre_anti_poisons": "String",\n' +
            '                "electricte": {\n' +
            '                    "urgence_jour": "String",\n' +
            '                    "urgence_nuit": "String",\n' +
            '                    "renseignement": "String"\n' +
            '                },\n' +
            '                "gaz": {\n' +
            '                    "urgence_jour": "String",\n' +
            '                    "urgence_nuit": "String",\n' +
            '                    "renseignement": "String"\n' +
            '                },\n' +
            '                "service_des_eaux": {\n' +
            '                    "urgence_jour": "String",\n' +
            '                    "urgence_nuit": "String",\n' +
            '                    "renseignement": "String"\n' +
            '                },\n' +
            '                "mairie": {\n' +
            '                    "tél": "String",\n' +
            '                    "adresse": "String"\n' +
            '                },\n' +
            '                "prefecture": {\n' +
            '                    "tél": "String",\n' +
            '                    "adresse": "String"\n' +
            '                },\n' +
            '                "inspection_travail": {\n' +
            '                    "tél": "String",\n' +
            '                    "adresse": "String"\n' +
            '                },\n' +
            '                "inspection_installations_classées": {\n' +
            '                    "tél": "String",\n' +
            '                    "adresse": "String"\n' +
            '                },\n' +
            '                "installateurs": {\n' +
            '                    "eau": {\n' +
            '                        "tel": "String",\n' +
            '                        "adresse": "String"\n' +
            '                    },\n' +
            '                    "gaz": {\n' +
            '                        "tel": "String",\n' +
            '                        "adresse": "String"\n' +
            '                    },\n' +
            '                    "electricite": {\n' +
            '                        "tel": "String",\n' +
            '                        "adresse": "String"\n' +
            '                    },\n' +
            '                    "chauffage": {\n' +
            '                        "tel": "String",\n' +
            '                        "adresse": "String"\n' +
            '                    },\n' +
            '                    "telephone": {\n' +
            '                        "tel": "String",\n' +
            '                        "adresse": "String"\n' +
            '                    },\n' +
            '                    "ascenseurs": {\n' +
            '                        "tel": "String",\n' +
            '                        "adresse": "String"\n' +
            '                    },\n' +
            '                    "cuisine": {\n' +
            '                        "tel": "String",\n' +
            '                        "adresse": "String"\n' +
            '                    }\n' +
            '                },\n' +
            '                "verificateurs_agrees": {\n' +
            '                    "installation_electrique": {\n' +
            '                        "tel": "String",\n' +
            '                        "adresse": "String"\n' +
            '                    },\n' +
            '                    "installation_gaz": {\n' +
            '                        "tel": "String",\n' +
            '                        "adresse": "String"\n' +
            '                    },\n' +
            '                    "installation_desenfumage": {\n' +
            '                        "tel": "String",\n' +
            '                        "adresse": "String"\n' +
            '                    },\n' +
            '                    "installation_ascenseur": {\n' +
            '                        "tel": "String",\n' +
            '                        "adresse": "String"\n' +
            '                    },\n' +
            '                    "installation_cuisson": {\n' +
            '                        "tel": "String",\n' +
            '                        "adresse": "String"\n' +
            '                    }\n' +
            '                }\n' +
            '            },\n' +
            '            "suivi_incidents": [{\n' +
            '                "type": "ObjectId",\n' +
            '                "ref": "SuiviIncidents"\n' +
            '            }]\n' +
            '        }\n' +
            '    },\n' +
            '    "SuiviIncidents": {\n' +
            '        "collection": "suiviincidents",\n' +
            '        "schema": {\n' +
            '            "_id": "ObjectId",\n' +
            '            "date_incident": "Date",\n' +
            '            "nature_incident": "String",\n' +
            '            "mesures_prises_immediatement": "String",\n' +
            '            "suite_donnees": "String",\n' +
            '            "auteur_suivi": {\n' +
            '                "type": "ObjectId",\n' +
            '                "ref": "RegistreUniqueDuPersonnel"\n' +
            '            },\n' +
            '            "visa": "Buffer"\n' +
            '        }\n' +
            '    },\n' +
            '    "Etablissements": {\n' +
            '        "collection": "etablissements",\n' +
            '        "schema": {\n' +
            '            "_id": "ObjectId",\n' +
            '            "raison_sociale": "String",\n' +
            '            "tel": "String",\n' +
            '            "adresse1": "String",\n' +
            '            "adresse2": "String",\n' +
            '            "code_postal": "String",\n' +
            '            "ville": "String",\n' +
            '            "representant_legal": {\n' +
            '                "type": "ObjectId",\n' +
            '                "ref": "RegistreUniqueDuPersonnel"\n' +
            '            }\n' +
            '\n' +
            '\n' +
            '        }\n' +
            '    }\n' +
            '}');
     function init() {
             console.log("Directory_schema : ", directory_schema);
     }

    </script>

    <!-- Loads and initializes the library -->
    <script type="text/javascript" src="src/js/mxClient.js"></script>

    <!-- Example code -->
    <script type="text/javascript">
        // Program starts here. Creates a sample graph in the
        // DOM node with the specified ID. This function is invoked
        // from the onLoad event handler of the document (see below).
        function main(container)
        {
            // Checks if the browser is supported
            if (!mxClient.isBrowserSupported())
            {
                mxUtils.error('Browser is not supported!', 200, false);
            }
            else
            {
                // Creates the graph inside the given container
                var graph = new mxGraph(container);

                // Enables rubberband selection
                new mxRubberband(graph);

                // Gets the default parent for inserting new cells. This
                // is normally the first child of the root (ie. layer 0).
                var parent = graph.getDefaultParent();

                var style = new Object();
                style[mxConstants.STYLE_SHAPE] = mxConstants.SHAPE_RECTANGLE;
                style[mxConstants.STYLE_OPACITY] = 50;
                style[mxConstants.STYLE_FONTCOLOR]= '#774400';
                style[mxConstants.STYLE_ROUNDED] = true;
                graph.getStylesheet().putCellStyle('ROUNDED',style);


                // Adds cells to the model in a single step
                graph.getModel().beginUpdate();
                var mcd = {};
                var x=20, y=20;
                var deltaX = 20, deltaY = 50;
                try
                {
                    for (modele in directory_schema) {
                        mcd[modele] = graph.insertVertex(parent, null, modele.toString(),  x, y, modele.toString().length*7, 30, 'ROUNDED');
                        x+=deltaX+modele.toString().length*7;
                        if (x >= 900) {
                            y+=deltaY;
                            x = 20;
                        }
                    }

                    // todo ajouter des tests pour connaître les liaisons de clés externes.
                        //var v1 = graph.insertVertex(parent, null, 'Hello',  20, 20, 80, 30, 'ROUNDED');
                        //var v2 = graph.insertVertex(parent, null, 'World!', 200, 150, 80, 30, 'ROUNDED');
                        //var e1 = graph.insertEdge(parent, null, '', v1, v2);
                }
                finally
                {
                    // Updates the display
                    graph.getModel().endUpdate();
                }
                var tableObject = new Table('TABLENAME');
                var table = new mxCell(tableObject, new mxGeometry(0, 0, 200, 28), 'table');
                var model = graph.getModel();
                var v1 = model.cloneCell(table);
                model.beginUpdate();
                try
                {
                    v1.value.name = name;
                    v1.geometry.x = 150;
                    v1.geometry.y = 200;
                    graph.addCell(v1, parent);
                    v1.geometry.alternateBounds = new mxRectangle(0, 0, v1.geometry.width, v1.geometry.height);
                    //v1.children[0].value.name = '_ID';
                }
                finally
                {
                    model.endUpdate();
                }

                // Defines the table user object
                function Table(name)
                {
                    this.name = name;
                };

                Table.prototype.clone = function()
                {
                    return mxUtils.clone(this);
                };
            }
        };
    </script>
</head>

<!-- Page passes the container for the graph to the program -->
<body onload="main(document.getElementById('graphContainer')); init();">

<!-- Creates a container for the graph with a grid wallpaper -->
<div id="graphContainer"
     style="overflow:hidden;width:100%;height:80%;background:url('src/images/grid.gif')">
</div>
</body>
</html>